let pressKey={keyLeft:!1,keyRight:!1,keyJump:!1},jump={status:0,height:32,distance:32,from:boundInfo.h-2*pixel,count:1},map={floor:boundInfo.h-2*pixel,goal:5,end:!1},charaStatus={speed:1.8,onGround:!1},initScenePos={x:0,y:-64};function init(){scene.position.set(initScenePos.x,initScenePos.y),jump.status=1,app.ticker.add((e=>gameLoop(e)))}function gameLoop(e){gameStatus(),map.end||showScene(),chaMove(e)}function gameStatus(){doorOpen.visible&&boxesIntersect(chara,doorOpen)&&chara.x>doorOpen.getGlobalPosition().x&&chara.x-16<doorOpen.getGlobalPosition().x&&(scene.visible=!1,endScene.visible=!0,doorOpen.visible=!1,map.end=!0),bg1.x-=.5,bg2.x-=.5,-640==bg1.x&&(bg1.x=640),-640==bg2.x&&(bg2.x=640)}function showScene(){let e=4;switch(wallsGroup.forEach((a=>{if(chara.x+chara.width>=a.wall.getGlobalPosition().x-2*pixel&&chara.x<=a.wall.getGlobalPosition().x+a.wall.width+2*pixel&&a.wall.getGlobalPosition().y>=chara.y-100&&a.wall.getGlobalPosition().y<=chara.y+chara.height+5){let t=detectWall(a);t<e&&(e=t)}})),e){case 1:jump.distance=0;break;case 2:jump.distance=16;break;case 3:jump.distance=24}starGroup.forEach((e=>{e.exist&&detectStar(e)}))}function detectWall(e){if(chara.y<e.wall.getGlobalPosition().y?e.isUp=!0:chara.y>e.wall.getGlobalPosition().y+e.wall.height&&(e.isUp=!1),chara.x>e.wall.getGlobalPosition().x+e.wall.width?(e.isMiddle=!1,e.isRight=!0):chara.x+chara.width<e.wall.getGlobalPosition().x?(e.isMiddle=!1,e.isRight=!1):e.isMiddle=!0,e.isUp&&(boxesIntersect(chara,e.wall)?jump.from=e.wall.getGlobalPosition().y-chara.height+1:(jump.from=map.floor,jump.status=jump.count,e.isUp=!1)),!e.isUp){if(e.isMiddle)for(let a=1;a<=3;a++)if(chara.y==e.wall.getGlobalPosition().y+pixel*a||chara.y==e.wall.getGlobalPosition().y+pixel*a+1)return a;boxesIntersect(chara,e.wall)&&(e.isRight||(chara.x=e.wall.getGlobalPosition().x-chara.width),e.isRight&&(chara.x=e.wall.getGlobalPosition().x+e.wall.width))}}function detectStar(e){boxesIntersect(chara,e.star)&&chara.x+20>e.star.getGlobalPosition().x&&chara.x-10<e.star.getGlobalPosition().x&&(e.star.visible=!1,e.exist=!1,score++,scoreNum.innerHTML=score,score>=map.goal&&(doorOpen.visible=!0))}function chaMove(e){pressKey.keyLeft&&(closeMainChaPic(walkLeft),camera("left",charaStatus.speed+e)||(chara.x-=charaStatus.speed+e)),pressKey.keyRight&&(closeMainChaPic(walkRight),camera("right",charaStatus.speed+e)||(chara.x+=charaStatus.speed+e)),jump.status>0&&(jump.distance-=2,camera("jump",jump.distance)||(chara.y-=jump.distance),jump.distance*=.8,chara.y>=jump.from&&(chara.y=jump.from,jump.status=0))}function camera(e,a){switch(e){case"right":return chara.x>=stage.w-2*pixel?(chara.x=stage.w-2*pixel,!1):chara.x>=stage.w-3*pixel&&stage.w-boundInfo.w<scene.x&&(scene.x-=a,stage.w-boundInfo.w>scene.x&&(scene.x=stage.w-boundInfo.w),!0);case"left":return chara.x<pixel?(chara.x=pixel,!1):chara.x<=2*pixel&&scene.x<0&&(scene.x+=a,scene.x>0&&(scene.x=0),!0);case"jump":return chara.y<=3*pixel&&scene.y<0?(scene.y-=a,!(scene.y>0&&(scene.y=0,1))):chara.y>=stage.h-2*pixel?(jump.from=stage.h-2*pixel,chara.y=jump.from,!1):chara.y>=stage.h-3*pixel&&stage.h-boundInfo.h<scene.y&&(scene.y+=a,stage.h-boundInfo.h>scene.y&&(scene.y=stage.h-boundInfo.h),!0)}}function closeMainChaPic(e){stopLeft.visible=!1,stopRight.visible=!1,walkLeft.visible=!1,walkRight.visible=!1,e.visible=!0}function boxesIntersect(e,a){let t=e.getBounds(),s=a.getBounds();return t.x+t.width>s.x&&t.x<s.x+s.width&&t.y+t.height>s.y&&t.y<s.y+s.height}init(),document.onkeydown=function(e){"ArrowLeft"===e.key&&(pressKey.keyLeft=!0,walkLeft.play()),"ArrowRight"===e.key&&(pressKey.keyRight=!0,walkRight.play())," "===e.key&&!pressKey.keyJump&&jump.status<jump.count&&(jump.distance=jump.height,pressKey.keyJump=!0,jump.status+=1)},document.onkeyup=function(e){"ArrowLeft"===e.key&&(pressKey.keyLeft=!1,closeMainChaPic(stopLeft),walkLeft.stop()),"ArrowRight"===e.key&&(pressKey.keyRight=!1,closeMainChaPic(stopRight),walkRight.stop())," "===e.key&&(pressKey.keyJump=!1)};